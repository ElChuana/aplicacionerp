-- Importación idempotente de movimientos Banco Internacional (Los Alerces)
-- Periodo: julio a octubre 2025
-- Cuenta: company_id=1, account_no='9137880' (Banco Internacional - Cuenta Corriente)
-- Convención: debit = Abono (entra dinero), credit = Cargo (sale dinero)

-- Abortará si la cuenta no existe
WITH x AS (
  SELECT COUNT(*) cnt FROM bank_accounts WHERE company_id=1 AND account_no='9137880'
)
SELECT 1 / CASE WHEN cnt=1 THEN 1 ELSE 0 END FROM x;

BEGIN;

WITH acct AS (
  SELECT id FROM bank_accounts WHERE company_id=1 AND account_no='9137880'
), rows AS (
  -- fecha, descripcion, cargo, abono (valores en CLP)
  SELECT DATE '2025-07-01' AS bank_date, 'INTERES POR USO LINEA DE CREDITO 9223684' AS description, 453069::numeric AS cargo, 0::numeric AS abono UNION ALL
  SELECT DATE '2025-07-01', 'ITE SOBGR/PACTADO 9223684', 15969, 0 UNION ALL
  SELECT DATE '2025-07-01', 'TRANSF. DE FONDOS DE 9223684', 0, 469038 UNION ALL
  SELECT DATE '2025-07-07', 'COMISION X MANTENCION CTA.CTE.', 117801, 0 UNION ALL
  SELECT DATE '2025-07-07', 'IVA DE LA COMISION', 22382, 0 UNION ALL
  SELECT DATE '2025-07-07', 'TRANSF. DE FONDOS DE 9223684', 0, 140183 UNION ALL
  SELECT DATE '2025-07-11', 'TRASPASO ENTRE CUENTAS', 0, 91000000 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA Constructora Nueva RSA', 2920675, 0 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA Global Advisors Management Ltd', 5000000, 0 UNION ALL
  SELECT DATE '2025-07-11', 'TRANSF. PARA diseno y arquitectura spa', 4113359, 0 UNION ALL
  SELECT DATE '2025-07-11', 'CARGO POR SERVICIOS LEGALES', 19635, 0 UNION ALL
  SELECT DATE '2025-07-11', 'AMORTIZACION AUTOMATICA LCR 9223684', 22946331, 0 UNION ALL
  SELECT DATE '2025-07-14', 'TRANSF. PARA INM DOnA CATALINA SPA', 5527295, 0 UNION ALL
  SELECT DATE '2025-07-14', 'TRANSF. DE FONDOS DE 9223684', 0, 5527295 UNION ALL
  SELECT DATE '2025-07-15', 'TRANSF. PARA S Y C CONSTRUCCIONES Y MAQUINA', 3500000, 0 UNION ALL
  SELECT DATE '2025-07-15', 'TRANSF. DE FONDOS DE 9223684', 0, 3500000 UNION ALL
  SELECT DATE '2025-07-17', 'TRANSF. PARA TEPILLE SPA', 438402, 0 UNION ALL
  SELECT DATE '2025-07-17', 'TRANSF. PARA diseno y arquitectura spa', 88398, 0 UNION ALL
  SELECT DATE '2025-07-17', 'TRANSF. PARA PLANOK', 186578, 0 UNION ALL
  SELECT DATE '2025-07-17', 'TRANSF. DE FONDOS DE 9223684', 0, 713378 UNION ALL
  SELECT DATE '2025-07-21', 'TRANSF. PARA Global Advisors Management Ltd', 3473818, 0 UNION ALL
  SELECT DATE '2025-07-21', 'PAGO AO 5033', 289214, 0 UNION ALL
  SELECT DATE '2025-07-21', 'TRANSF. DE FONDOS DE 9223684', 0, 3763032 UNION ALL
  SELECT DATE '2025-07-24', 'TRANSF. PARA Kleber Home SpA', 7000000, 0 UNION ALL
  SELECT DATE '2025-07-24', 'TRANSF. DE FONDOS DE 9223684', 0, 7000000 UNION ALL
  SELECT DATE '2025-08-01', 'INTERES POR USO LINEA DE CREDITO 9223684', 361443, 0 UNION ALL
  SELECT DATE '2025-08-01', 'ITE SOBGR/PACTADO 9223684', 11404, 0 UNION ALL
  SELECT DATE '2025-08-01', 'TRANSF. DE FONDOS DE 9223684', 0, 372847 UNION ALL
  SELECT DATE '2025-08-05', 'TRANSF. PARA ROCIO LIZANA ARENAS', 80000, 0 UNION ALL
  SELECT DATE '2025-08-05', 'TRANSF. DE FONDOS DE 9223684', 0, 80000 UNION ALL
  SELECT DATE '2025-08-11', 'COMISION X MANTENCION CTA.CTE.', 97948, 0 UNION ALL
  SELECT DATE '2025-08-11', 'IVA DE LA COMISION', 18610, 0 UNION ALL
  SELECT DATE '2025-08-11', 'TRANSF. DE FONDOS DE 9223684', 0, 116558 UNION ALL
  SELECT DATE '2025-08-13', 'PRESTAMO OTORGADO NUMERO 9858855', 0, 31406303 UNION ALL
  SELECT DATE '2025-08-13', 'AMORTIZACION AUTOMATICA LCR 9223684', 22361246, 0 UNION ALL
  SELECT DATE '2025-08-14', 'TRASPASO ENTRE CUENTAS', 0, 77000000 UNION ALL
  SELECT DATE '2025-08-18', 'TRANSF. PARA Constructora Nueva RSA', 6000000, 0 UNION ALL
  SELECT DATE '2025-08-18', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-18', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-18', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-18', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-18', 'TRANSF. PARA Joaquin Achurra', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-18', 'TRANSF. PARA Joaquin Achurra', 1945667, 0 UNION ALL
  SELECT DATE '2025-08-18', 'TRANSF. PARA Carlos Alliende Villarroel', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-18', 'TRANSF. PARA Carlos Alliende Villarroel', 1945667, 0 UNION ALL
  SELECT DATE '2025-08-19', 'TRANSF. PARA DANIELA YANIRE SILVA', 1687121, 0 UNION ALL
  SELECT DATE '2025-08-19', 'TRANSF. PARA TEPILLE SPA', 1398823, 0 UNION ALL
  SELECT DATE '2025-08-19', 'TRANSF. PARA PLANOK', 326780, 0 UNION ALL
  SELECT DATE '2025-08-19', 'TRANSF. PARA GUILLERMO ENRIQUE GONZALE', 1000000, 0 UNION ALL
  SELECT DATE '2025-08-19', 'TRANSF. PARA Leonardo Sebastian Alvarez', 864691, 0 UNION ALL
  SELECT DATE '2025-08-20', 'TRANSF. PARA Aguas Andinas SA', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-20', 'TRANSF. PARA Aguas Andinas SA', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-20', 'TRANSF. PARA Aguas Andinas SA', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-20', 'TRANSF. PARA Aguas Andinas SA', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-20', 'TRANSF. PARA Aguas Andinas SA', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-20', 'TRANSF. PARA Aguas Andinas SA', 3778506, 0 UNION ALL
  SELECT DATE '2025-08-20', 'TRANSF. DE FONDOS DE 9223684', 0, 9902198 UNION ALL
  SELECT DATE '2025-08-21', 'TRANSF. PARA Victor Hugo Vasquez', 176200, 0 UNION ALL
  SELECT DATE '2025-08-21', 'TRANSF. DE FONDOS DE 9223684', 0, 176200 UNION ALL
  SELECT DATE '2025-08-25', 'CARGOS POR RENOVACION CREDITO 9223684', 137602, 0 UNION ALL
  SELECT DATE '2025-08-25', 'TRANSF. DE FONDOS DE 9223684', 0, 137602 UNION ALL
  SELECT DATE '2025-08-26', 'TRANSF. PARA Sandra Engell', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-26', 'TRANSF. PARA Sandra Engell', 3189640, 0 UNION ALL
  SELECT DATE '2025-08-26', 'TRANSF. DE FONDOS DE 9223684', 0, 10189640 UNION ALL
  SELECT DATE '2025-08-27', 'Transferencia de otro banco 8867717-K', 0, 250000 UNION ALL
  SELECT DATE '2025-08-27', 'AMORTIZACION AUTOMATICA LCR 9223684', 250000, 0 UNION ALL
  SELECT DATE '2025-08-28', 'Transferencia de otro banco 8867717-K', 0, 5000000 UNION ALL
  SELECT DATE '2025-08-28', 'TRANSF. PARA Julian Miranda Osses', 72500, 0 UNION ALL
  SELECT DATE '2025-08-28', 'AMORTIZACION AUTOMATICA LCR 9223684', 4927500, 0 UNION ALL
  SELECT DATE '2025-08-29', 'TRANSF. PARA Thomas Engell', 7000000, 0 UNION ALL
  SELECT DATE '2025-08-29', 'TRANSF. DE FONDOS DE 9223684', 0, 7000000 UNION ALL
  SELECT DATE '2025-09-01', 'Transferencia de otro banco 8867717-K', 0, 750000 UNION ALL
  SELECT DATE '2025-09-01', 'TRANSF. PARA Thomas Engell', 3189640, 0 UNION ALL
  SELECT DATE '2025-09-01', 'INTERES POR USO LINEA DE CREDITO 9223684', 317265, 0 UNION ALL
  SELECT DATE '2025-09-01', 'ITE SOBGR/PACTADO 9223684', 12368, 0 UNION ALL
  SELECT DATE '2025-09-01', 'TRANSF. DE FONDOS DE 9223684', 0, 2769273 UNION ALL
  SELECT DATE '2025-09-15', 'PRESTAMO OTORGADO NUMERO 9883703', 0, 34774229 UNION ALL
  SELECT DATE '2025-09-15', 'AMORTIZACION AUTOMATICA LCR 9223684', 24997413, 0 UNION ALL
  SELECT DATE '2025-09-16', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-09-16', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-09-16', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-09-16', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-09-16', 'TRANSF. PARA Constructora Nueva RSA', 6775816, 0 UNION ALL
  SELECT DATE '2025-09-16', 'TRANSF. DE FONDOS DE 9223684', 0, 24999000 UNION ALL
  SELECT DATE '2025-10-01', 'INTERES POR USO LINEA DE CREDITO 9223684', 511780, 0 UNION ALL
  SELECT DATE '2025-10-01', 'ITE SOBGR/PACTADO 9223684', 16499, 0 UNION ALL
  SELECT DATE '2025-10-01', 'TRANSF. DE FONDOS DE 9223684', 0, 1000 UNION ALL
  SELECT DATE '2025-10-09', 'COMISION POR MANTENCION CTA. CTE.', 118457, 0 UNION ALL
  SELECT DATE '2025-10-09', 'IVA DE LA COMISION', 22507, 0 UNION ALL
  SELECT DATE '2025-10-16', 'PRESTAMO OTORGADO NUMERO 9906917', 0, 35512749 UNION ALL
  SELECT DATE '2025-10-16', 'AMORTIZACION AUTOMATICA LCR 9223684', 25000000, 0 UNION ALL
  SELECT DATE '2025-10-17', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-10-17', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-10-17', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-10-17', 'TRANSF. PARA Constructora Nueva RSA', 7000000, 0 UNION ALL
  SELECT DATE '2025-10-17', 'TRANSF. PARA Constructora Nueva RSA', 6800000, 0 UNION ALL
  SELECT DATE '2025-10-17', 'TRANSF. DE FONDOS DE 9223684', 0, 24955494 UNION ALL
  SELECT DATE '2025-10-30', 'INTERESES POR SOBREGIRO', 11838, 0 UNION ALL
  SELECT DATE '2025-10-30', 'ITE SOBREGIRO NO PACTADO', 391, 0 UNION ALL
  SELECT DATE '2025-10-30', 'TRANSF. DE FONDOS DE 9223684', 0, 12229
)
INSERT INTO bank_movements (bank_account_id, project_id, bank_date, description, debit, credit, currency, source, sub_account_id)
SELECT a.id, NULL, r."date", r.description,
       NULLIF(r.abono, 0), NULLIF(r.cargo, 0), 'CLP', 'cartola', NULL
FROM (
  SELECT bank_date as "date", description, cargo, abono FROM rows
) r
CROSS JOIN acct a
WHERE NOT EXISTS (
  SELECT 1 FROM bank_movements bm
  WHERE bm.bank_account_id = a.id
    AND bm.bank_date = r."date"
    AND bm.description = r.description
    AND COALESCE(bm.debit, 0) = COALESCE(NULLIF(r.abono, 0), 0)
    AND COALESCE(bm.credit, 0) = COALESCE(NULLIF(r.cargo, 0), 0)
);

COMMIT;

-- Verificaciones
SELECT 'Movimientos insertados Banco Internacional 07-10/2025' AS info,
       COUNT(*) AS total
FROM bank_movements
WHERE bank_account_id = (SELECT id FROM bank_accounts WHERE company_id=1 AND account_no='9137880')
  AND bank_date BETWEEN DATE '2025-07-01' AND DATE '2025-10-31';

SELECT 'Totales por tipo' AS info,
       TO_CHAR(SUM(COALESCE(debit,0)), 'FM999,999,999,999') AS total_abonos,
       TO_CHAR(SUM(COALESCE(credit,0)), 'FM999,999,999,999') AS total_cargos
FROM bank_movements
WHERE bank_account_id = (SELECT id FROM bank_accounts WHERE company_id=1 AND account_no='9137880')
  AND bank_date BETWEEN DATE '2025-07-01' AND DATE '2025-10-31';
