// Sistema de prompts para el chatbot - Define el contexto y l√≠mites del bot

export const SYSTEM_PROMPT = `Eres un asistente de an√°lisis financiero para un ERP inmobiliario chileno.

REGLAS ESTRICTAS:
1. SOLO puedes responder sobre datos financieros del ERP
2. NO puedes dar consejos financieros o legales
3. NO puedes hablar de temas que no sean datos del sistema
4. Si te preguntan algo fuera del ERP, responde: "Solo puedo ayudarte con consultas sobre datos del ERP"
5. SIEMPRE usa formato de n√∫meros chilenos (separador de miles con puntos)
6. Las cantidades en CLP deben tener el s√≠mbolo $ antes
7. Las cantidades en UF deben incluir "UF" despu√©s
8. Responde de forma concisa y profesional

DATOS QUE PUEDES CONSULTAR:
- Centros de costo y sus movimientos
- Movimientos bancarios
- Obligaciones (proveedores, contratos)
- Cr√©ditos
- Subcuentas contables
- Proyectos inmobiliarios (edificios, condominios, loteos)
- Unidades inmobiliarias (departamentos, casas, oficinas, estacionamientos)
- Clientes (personas y empresas)
- Cotizaciones de ventas
- Promesas de compra
- Reportes de ventas
- Cuentas bancarias

FORMATO DE RESPUESTAS:
- Usa emojis relevantes (üìä üí∞ üè¢ üìà üìâ)
- Presenta n√∫meros con formato claro
- Si los datos son muchos, resume lo m√°s importante
- Ofrece seguir consultando m√°s detalles

IMPORTANTE:
- Solo trabajas con UNA empresa a la vez (company_id = 1 por defecto)
- Las fechas deben estar en formato YYYY-MM-DD
- Todos los montos est√°n en CLP o UF chilenos`;
 
// Modo avanzado seguro:
// Si no encuentras una funci√≥n predefinida adecuada, puedes proponer una consulta din√°mica SOLO LECTURA
// y llamar a run_dynamic_sql con un SELECT que cumpla estas reglas INNEGOCIABLES:
// - Solo SELECT (sin INSERT/UPDATE/DELETE ni DDL)
// - Sin JOIN (usa solo una tabla/vista)
// - Tablas/vistas permitidas: obligations_summary, projects, clients
// - Debe filtrar por company_id = 1
// - Debe tener LIMIT <= 100
// - Prioriza SIEMPRE las funciones predefinidas; esto es √∫ltimo recurso.

export const FUNCTION_DEFINITIONS = [
  {
    name: "get_cost_centers_summary",
    description: "Obtiene el resumen de todos los centros de costo con sus totales en CLP y UF",
    parameters: {
      type: "object",
      properties: {
        company_id: {
          type: "number",
          description: "ID de la empresa (siempre 1)"
        }
      },
      required: ["company_id"]
    }
  },
  {
    name: "get_cost_center_detail",
    description: "Obtiene el detalle de un centro de costo espec√≠fico incluyendo subcuentas y movimientos",
    parameters: {
      type: "object",
      properties: {
        company_id: {
          type: "number",
          description: "ID de la empresa"
        },
        cost_center_id: {
          type: "number",
          description: "ID del centro de costo"
        }
      },
      required: ["company_id", "cost_center_id"]
    }
  },
  {
    name: "get_bank_movements",
    description: "Consulta movimientos bancarios con filtros opcionales",
    parameters: {
      type: "object",
      properties: {
        company_id: {
          type: "number",
          description: "ID de la empresa"
        },
        unassigned: {
          type: "boolean",
          description: "Si es true, solo devuelve movimientos sin centro de costo asignado"
        },
        date_from: {
          type: "string",
          description: "Fecha inicial en formato YYYY-MM-DD"
        },
        date_to: {
          type: "string",
          description: "Fecha final en formato YYYY-MM-DD"
        }
      },
      required: ["company_id"]
    }
  },
  {
    name: "get_obligations",
    description: "Obtiene lista de obligaciones (contratos, proveedores) con sus montos y estados",
    parameters: {
      type: "object",
      properties: {
        company_id: {
          type: "number",
          description: "ID de la empresa"
        },
        status: {
          type: "string",
          description: "Estado de la obligaci√≥n: 'pending', 'paid', 'all'",
          enum: ["pending", "paid", "all"]
        }
      },
      required: ["company_id"]
    }
  },
  {
    name: "get_monthly_summary",
    description: "Genera un resumen mensual de ingresos y gastos por centro de costo",
    parameters: {
      type: "object",
      properties: {
        company_id: {
          type: "number",
          description: "ID de la empresa"
        },
        month: {
      {
        name: "run_dynamic_sql",
        description: "Ejecuta una consulta SQL segura y de solo lectura sobre vistas/tablas permitidas (√∫ltimo recurso)",
        parameters: {
          type: "object",
          properties: {
            sql: {
              type: "string",
              description: "Consulta SELECT segura sin JOIN, con WHERE company_id = 1 y LIMIT <= 100"
            },
            company_id: {
              type: "number",
              description: "ID de la empresa (1 por defecto)"
            }
          },
          required: ["sql"]
        }
      }
          type: "number",
          description: "Mes (1-12)"
        },
        year: {
          type: "number",
          description: "A√±o (ej: 2025)"
        }
      },
      required: ["company_id", "month", "year"]
    }
  },
  {
    name: "get_projects",
    description: "Obtiene lista de proyectos inmobiliarios con sus caracter√≠sticas",
    parameters: {
      type: "object",
      properties: {
        company_id: {
          type: "number",
          description: "ID de la empresa"
        },
        status: {
          type: "string",
          description: "Estado del proyecto: 'EN_DISENO', 'EN_CONSTRUCCION', 'EN_VENTA', 'ENTREGADO', 'FINALIZADO', 'all'",
          enum: ["EN_DISENO", "EN_CONSTRUCCION", "EN_VENTA", "ENTREGADO", "FINALIZADO", "all"]
        }
      },
      required: ["company_id"]
    }
  },
  {
    name: "get_units",
    description: "Consulta unidades inmobiliarias (departamentos, casas, oficinas, etc.)",
    parameters: {
      type: "object",
      properties: {
        project_id: {
          type: "number",
          description: "ID del proyecto (opcional)"
        },
        status: {
          type: "string",
          description: "Estado: 'DISPONIBLE', 'RESERVADO', 'VENDIDO', 'BLOQUEADO', 'all'",
          enum: ["DISPONIBLE", "RESERVADO", "VENDIDO", "BLOQUEADO", "all"]
        },
        unit_type: {
          type: "string",
          description: "Tipo: 'DEPARTAMENTO', 'CASA', 'OFICINA', 'LOCAL_COMERCIAL', 'ESTACIONAMIENTO', 'BODEGA', 'TERRENO', 'all'",
          enum: ["DEPARTAMENTO", "CASA", "OFICINA", "LOCAL_COMERCIAL", "ESTACIONAMIENTO", "BODEGA", "TERRENO", "all"]
        }
      },
      required: []
    }
  },
  {
    name: "get_clients",
    description: "Obtiene lista de clientes con sus cotizaciones y promesas",
    parameters: {
      type: "object",
      properties: {
        company_id: {
          type: "number",
          description: "ID de la empresa"
        },
        client_type: {
          type: "string",
          description: "Tipo de cliente: 'PERSONA', 'EMPRESA', 'all'",
          enum: ["PERSONA", "EMPRESA", "all"]
        }
      },
      required: []
    }
  },
  {
    name: "get_quotations",
    description: "Consulta cotizaciones de ventas con sus estados",
    parameters: {
      type: "object",
      properties: {
        company_id: {
          type: "number",
          description: "ID de la empresa"
        },
        status: {
          type: "string",
          description: "Estado: 'DRAFT', 'SENT', 'ACCEPTED', 'REJECTED', 'EXPIRED', 'all'",
          enum: ["DRAFT", "SENT", "ACCEPTED", "REJECTED", "EXPIRED", "all"]
        },
        client_id: {
          type: "number",
          description: "ID del cliente (opcional)"
        }
      },
      required: []
    }
  },
  {
    name: "get_promises",
    description: "Obtiene promesas de compra con montos de pie y saldo",
    parameters: {
      type: "object",
      properties: {
        company_id: {
          type: "number",
          description: "ID de la empresa"
        },
        status: {
          type: "string",
          description: "Estado: 'VIGENTE', 'RESCINDIDA', 'CUMPLIDA', 'all'",
          enum: ["VIGENTE", "RESCINDIDA", "CUMPLIDA", "all"]
        },
        client_id: {
          type: "number",
          description: "ID del cliente (opcional)"
        }
      },
      required: []
    }
  },
  {
    name: "get_sales_report",
    description: "Genera reporte de ventas por proyecto con totales",
    parameters: {
      type: "object",
      properties: {
        company_id: {
          type: "number",
          description: "ID de la empresa"
        },
        project_id: {
          type: "number",
          description: "ID del proyecto (opcional)"
        },
        date_from: {
          type: "string",
          description: "Fecha inicial en formato YYYY-MM-DD"
        },
        date_to: {
          type: "string",
          description: "Fecha final en formato YYYY-MM-DD"
        }
      },
      required: []
    }
  }
];

export const RESPONSE_TEMPLATES = {
  noData: "No encontr√© datos para tu consulta. Intenta ser m√°s espec√≠fico o preg√∫ntame sobre:\n\nüìä Centros de costo\nüí∞ Movimientos bancarios\nüìã Obligaciones\nÔøΩ Proyectos\nüè† Unidades disponibles\nüë• Clientes\nüìù Cotizaciones\nü§ù Promesas de compra",
  
  error: "Hubo un error al consultar los datos. Por favor intenta nuevamente.",
  
  outOfScope: "Solo puedo ayudarte con consultas sobre datos del ERP inmobiliario.\n\nPuedo mostrarte:\n‚Ä¢ Centros de costo\n‚Ä¢ Movimientos bancarios\n‚Ä¢ Obligaciones\n‚Ä¢ Proyectos inmobiliarios\n‚Ä¢ Unidades (departamentos, casas, oficinas)\n‚Ä¢ Clientes y cotizaciones\n‚Ä¢ Promesas de compra\n‚Ä¢ Reportes de ventas"
};

// Funci√≥n para validar que una pregunta est√° dentro del scope
export function isValidQuery(message: string): boolean {
  const validKeywords = [
    'centro', 'costo', 'movimiento', 'banco', 'obligacion', 'credito',
    'gasto', 'ingreso', 'pago', 'cuenta', 'proyecto', 'resumen',
    'cuanto', 'total', 'mes', 'a√±o', 'dinero', 'plata', 'peso', 'uf',
    'unidad', 'departamento', 'casa', 'oficina', 'cliente', 'cotizacion',
    'promesa', 'venta', 'vendido', 'disponible', 'reservado', 'edificio',
    'condominio', 'inmobiliaria', 'propiedad', 'compra'
  ];
  
  const messageLower = message.toLowerCase();
  return validKeywords.some(keyword => messageLower.includes(keyword));
}
